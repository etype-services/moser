<?php
/**
 * Implements hook_block_info()
 */
function etype_sliderad_block_info() {
  $blocks = array();

  $blocks['Slider Ad'] = array(
    'info' => t('Slider Ad'),
  );

  return $blocks;

}

/**
 * @param string $delta
 * @return array
 * Implements hook_block_view()
 */
function etype_sliderad_block_view($delta = '') {
  $block = array();
  switch ($delta) {

    case 'Slider Ad':
      $block['subject'] = '';
      $block['content'] = etype_sliderad_content();
      break;
  }

  return $block;
}

/**
 *
 */
function etype_sliderad_content() {

  $query = new EntityFieldQuery();
  $result = $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'sliderad')
    ->propertyCondition('status', NODE_PUBLISHED)
    ->fieldCondition('field_ad_status', 'value', '1', '=')
    ->fieldCondition('field_ad_start_date', 'value', date(''), '<') // end date before now
    ->fieldCondition('field_ad_end_date', 'value', date(''), '>') // end date after now
    ->execute();
  $nodes = node_load_multiple(array_keys($result['node']));

  $tmp = print_r($nodes);

  $output = "<p>Slider Ad</p>" . $tmp;
  return $output;
}

/**
 * Implements hook_node_presave()
 * Format date fields or storing
 */
function etype_sliderad_node_presave($node) {

  if ($node->type == 'sliderad') {

    $start_date = 0;
    $end_date = 0;
    $start_time = 0;
    $end_time = 0;

    if (isset($node->field_ad_start_date[$node->language]) && !empty($node->field_ad_start_date[$node->language][0]['value'])) {
      $start_date = $node->field_ad_start_date[$node->language][0]['value'];
    }
    if (isset($node->field_ad_end_date[$node->language]) && !empty($node->field_ad_end_date[$node->language][0]['value'])) {
      $end_date = $node->field_ad_end_date[$node->language][0]['value'];
    }

    if (isset($node->field_sliderad_start_time[$node->language]) && !empty($node->field_sliderad_start_time[$node->language][0]['value'])) {
      $start_time = $node->field_sliderad_start_time[$node->language][0]['value'];
    }
    if (isset($node->field_sliderad_end_time[$node->language]) && !empty($node->field_sliderad_end_time[$node->language][0]['value'])) {
      $end_time = $node->field_sliderad_end_time[$node->language][0]['value'];
    }

    $start_date = strtotime($start_date);
    $end_date = strtotime($end_date);
    $start_time = strtotime($start_time);
    $end_time = strtotime($end_time);

    if ($start_date != 0) {
      $node->field_ad_start_date[$node->language][0]['value'] = format_date($start_date, 'custom', 'm/d/Y h:i a');
    }
    if ($end_date != 0) {
      $node->field_ad_end_date[$node->language][0]['value'] = format_date($end_date, 'custom', 'm/d/Y h:i a');
    }

    if ($start_time != 0) {
      $node->field_sliderad_start_time[$node->language][0]['value'] = format_date($start_time, 'custom', 'h:i a');
    }
    if ($end_time != 0) {
      $node->field_sliderad_end_time[$node->language][0]['value'] = format_date($end_time, 'custom', 'h:i a');
    }
  }
}